<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Optics Data Viewer - Substrate Stabilization Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Potree CSS -->
  <link rel="stylesheet" href="../build/potree/potree.css" />
  <link rel="stylesheet" href="../libs/jquery-ui/jquery-ui.min.css" />
  <link rel="stylesheet" href="../libs/openlayers3/ol.css" />
  <link rel="stylesheet" href="../libs/spectrum/spectrum.css" />
  <link rel="stylesheet" href="../libs/jstree/themes/mixed/style.css" />
  
  <!-- Leaflet for OpenStreetMap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
    
    /* Loading + error */
    #loading {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(10,10,15,.7); color:#e8eefc; font:15px system-ui,Segoe UI,Roboto,Arial;
      z-index:9999; flex-direction:column; gap:10px
    }
    #loading .spinner { width:40px; height:40px; border-radius:50%;
      border:3px solid rgba(255,255,255,.25); border-top-color:#fff; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg) } }

    #error {
      position:absolute; top:12px; left:12px; right:12px;
      background:rgba(180,30,40,.9); color:#fff; padding:10px 12px; border-radius:8px; display:none; z-index:10000
    }

    .chip{
      position:absolute; bottom:12px; left:12px; background:rgba(20,20,30,.55); color:#fff;
      padding:6px 10px; border-radius:10px; font:13px system-ui; z-index:4
    }

    /* Substrate Controls */
    #substrate-controls {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(30,30,40,0.9);
      color: #fff;
      padding: 15px;
      border-radius: 12px;
      font: 14px system-ui;
      z-index: 5000;
      min-width: 300px;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .panel-header {
      margin: 0 0 15px 0;
      color: #e8eefc;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: color 0.2s;
    }

    .panel-header:hover {
      color: #4CAF50;
    }

    .panel-collapse-icon {
      font-size: 14px;
      transition: transform 0.2s;
    }

    .panel-collapse-icon.collapsed {
      transform: rotate(-90deg);
    }

    .panel-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .panel-content.collapsed {
      max-height: 0;
    }

    /* Quality Controls */
    .quality-controls {
      margin-bottom: 15px;
    }

    .quality-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
    }

    .quality-label {
      font-weight: 500;
      flex: 1;
      font-size: 13px;
    }

    .quality-value {
      color: #4CAF50;
      font-size: 12px;
      font-family: monospace;
      margin-left: 10px;
      min-width: 60px;
      text-align: right;
    }

    .point-budget-slider {
      width: 100%;
      margin: 8px 0;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: rgba(255,255,255,0.2);
      outline: none;
      border-radius: 3px;
    }

    .point-budget-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
    }

    .point-budget-controls {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .budget-btn {
      background: rgba(76,175,80,0.8);
      border: 1px solid rgba(76,175,80,1);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font: 11px system-ui;
      transition: all 0.2s;
      flex: 1;
    }

    .budget-btn:hover {
      background: rgba(96,195,100,0.9);
      transform: translateY(-1px);
    }

    .toggle-btn {
      background: rgba(60,120,180,0.8);
      border: 1px solid rgba(60,120,180,1);
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font: 13px system-ui;
      transition: all 0.2s;
      width: 100%;
      margin-bottom: 8px;
    }

    .toggle-btn:hover {
      background: rgba(80,140,200,0.9);
      border-color: rgba(80,140,200,1);
    }

    .toggle-btn.active {
      background: rgba(40,200,120,0.9);
      border-color: rgba(40,200,120,1);
      box-shadow: 0 0 8px rgba(40,200,120,0.3);
    }

    /* Animation Controls */
    .animation-controls {
      border-top: 1px solid rgba(255,255,255,0.15);
      padding-top: 12px;
      margin-top: 12px;
    }

    .animation-btn {
      background: rgba(100,60,180,0.8);
      border: 1px solid rgba(100,60,180,1);
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font: 13px system-ui;
      transition: all 0.2s;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .animation-btn:hover {
      background: rgba(120,80,200,0.9);
    }

    .animation-btn.playing {
      background: rgba(200,40,40,0.9);
      border-color: rgba(200,40,40,1);
    }

    /* Location Map */
    .location-map {
      border-top: 1px solid rgba(255,255,255,0.15);
      padding-top: 12px;
      margin-top: 12px;
    }

    .location-map h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #e8eefc;
      font-weight: 600;
    }

    #map {
      width: 100%;
      height: 150px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .map-info {
      font-size: 11px;
      color: rgba(255,255,255,0.6);
      margin-top: 6px;
      text-align: center;
    }

    .section-divider {
      border-top: 1px solid rgba(255,255,255,0.15);
      padding-top: 12px;
      margin-top: 12px;
    }

    .performance-warning {
      background: rgba(255,193,7,0.1);
      border: 1px solid rgba(255,193,7,0.3);
      color: #ffc107;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 8px;
      display: none;
    }
  </style>
</head>
<body>

  <div id="potree_container" class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px;">
    <div id="potree_render_area">
    </div>
    <div id="potree_sidebar_container"> </div>
  </div>

  <!-- Substrate Controls -->
  <div id="substrate-controls">
    <h3 class="panel-header" id="substrate-header">
      <span class="panel-collapse-icon">‚ñº</span>
      üî¨ Substrate Stabilization Viewer
    </h3>
    
    <div class="panel-content" id="substrate-content">
      <!-- Quality Controls -->
      <div class="quality-controls">
        <div class="quality-item">
          <div class="quality-label">Point Budget:</div>
          <div class="quality-value" id="point-budget-display">5.0M</div>
        </div>
        <input type="range" class="point-budget-slider" id="point-budget-slider" 
               min="1" max="100" value="5" step="1">
        <div class="point-budget-controls">
          <button class="budget-btn" id="budget-low">Standard (5M)</button>
          <button class="budget-btn" id="budget-medium">High (25M)</button>
          <button class="budget-btn" id="budget-high">Ultra (50M)</button>
          <button class="budget-btn" id="budget-max">Maximum (100M)</button>
          <button class="budget-btn" id="test-budget" style="background:#e91e63;border-color:#e91e63;">Test Budget</button>
        </div>
        <div class="performance-warning" id="performance-warning">
          ‚ö†Ô∏è High point counts may impact performance on some devices
        </div>
        
        <!-- Debug status -->
        <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-top: 4px;" id="debug-status">
          Ready to load point cloud...
        </div>

        <!-- Point Size Controls -->
        <div class="quality-item" style="margin-top: 15px;">
          <div class="quality-label">Point Size:</div>
          <div class="quality-value" id="point-size-display">1.0</div>
        </div>
        <input type="range" class="point-budget-slider" id="point-size-slider" 
               min="0.1" max="5.0" value="1.0" step="0.1">
        <div class="point-budget-controls">
          <button class="budget-btn" id="size-tiny">Tiny (0.3)</button>
          <button class="budget-btn" id="size-small">Small (0.7)</button>
          <button class="budget-btn" id="size-normal">Normal (1.0)</button>
          <button class="budget-btn" id="size-large">Large (2.0)</button>
        </div>
      </div>

      <!-- Rendering Controls -->
      <div class="section-divider">
        <button class="toggle-btn" id="toggle-edl">Enable EDL (Eye-Dome Lighting)</button>
        <button class="toggle-btn" id="toggle-sidebar">Toggle Sidebar</button>
        <button class="toggle-btn" id="fit-screen">Fit to Screen</button>
      </div>

      <!-- Animation Controls -->
      <div class="animation-controls">
        <button class="animation-btn" id="toggle-rotation">üîÑ Rotate View</button>
        <button class="animation-btn" id="reset-view">Reset View</button>
        <button class="animation-btn" id="create-animation">Camera Animation</button>
      </div>

      <!-- Location Map -->
      <div class="location-map">
        <h4>üìç Study Site Location</h4>
        <div id="map"></div>
        <div class="map-info">Substrate Stabilization Site<br>Post Installation Survey</div>
      </div>
    </div>
  </div>

  <div id="error"></div>
  <div id="loading">
    <div class="spinner"></div>
    <div id="loading-text">Loading substrate stabilization viewer‚Ä¶</div>
    <div id="loading-progress" style="font-size:12px;opacity:0.8;margin-top:5px;"></div>
  </div>
  <div class="chip" id="chip">Substrate Stabilization Post Install</div>

  <!-- Libraries -->
  <script src="../libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="../libs/spectrum/spectrum.js"></script>
  <script src="../libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="../libs/other/BinaryHeap.js"></script>
  <script src="../libs/tween/tween.min.js"></script>
  <script src="../libs/d3/d3.js"></script>
  <script src="../libs/proj4/proj4.js"></script>
  <script src="../libs/openlayers3/ol.js"></script>
  <script src="../libs/i18next/i18next.js"></script>
  <script src="../libs/jstree/jstree.js"></script>

  <!-- Three.js -->
  <script src="../libs/three.js/build/three.min.js"></script>

  <!-- Potree -->
  <script src="../build/potree/potree.js"></script>
  
  <!-- Leaflet for OpenStreetMap -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Configuration for Substrate Stabilization project
    const PROJECT_CONFIG = {
      name: "Substrate Stabilization Post Install",
      description: "High-resolution point cloud analysis of substrate stabilization effectiveness",
      location: {
        lat: 21.3159693,
        lng: -158.1275808,
        name: "Hawaiian Waters",
        description: "Marine substrate stabilization monitoring"
      },
      pointCloud: {
        name: "Substrate Stabilization Post Install",
        url: "https://storage.googleapis.com/nmfs_odp_pifsc/PIFSC/ESD/ARP/data_management/temp/sfm_test/substrate_stabilization_post_install/cloud.js",
        color: new THREE.Color(0.2, 0.8, 0.9), // Cyan/blue tint for marine environment
      },
      initialView: {
        position: [0, 0, 100],
        target: [0, 0, 0]
      }
    };

    // Global variables
    let currentPointCloud = null;
    let isAnimating = false;
    let animationId = null;
    let currentRotationSpeed = 0.005;

    const errorBox = document.getElementById('error');
    const loading = document.getElementById('loading');

    function showError(msg, details) {
      errorBox.style.display = 'block';
      errorBox.innerHTML = `<strong>Couldn't load substrate point cloud.</strong> ${msg}`
        + (details ? `<div style="opacity:.9;margin-top:6px;font-size:13px">${details}</div>` : '');
      console.error('Substrate viewer load error:', msg, details);
      loading.style.display = 'none';
    }

    console.log('Initializing substrate viewer...');
    
    // Initialize viewer with standard settings, allow scaling up
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
    
    viewer.setEDLEnabled(false); // Start with EDL disabled for performance
    viewer.setFOV(60);
    viewer.setPointBudget(5_000_000); // Start at standard 5M points
    viewer.loadSettingsFromURL();
    viewer.setBackground("gradient");
    viewer.setDescription(PROJECT_CONFIG.description);
    
    console.log('Loading GUI...');
    
    // Load GUI
    viewer.loadGUI(() => {
      console.log('GUI loaded, setting up sidebar...');
      viewer.setLanguage('en');
      $("#menu_scene").next().show();
      $("#menu_tools").next().show();
      viewer.toggleSidebar();
      
      // Initialize export functionality
      initializeSidebarExports();
      
      // Initialize substrate controls
      initializeSubstrateControls();
      
      // Load the substrate point cloud
      loadSubstratePointCloud();
    });

    // Initialize substrate-specific controls
    function initializeSubstrateControls() {
      console.log('Initializing substrate controls...');
      
      // Initialize map
      initializeLocationMap();
      
      // Initialize panel collapse functionality
      const panelHeader = document.getElementById('substrate-header');
      const panelContent = document.getElementById('substrate-content');
      const panelIcon = panelHeader.querySelector('.panel-collapse-icon');
      
      // Set initial max-height for transition
      panelContent.style.maxHeight = panelContent.scrollHeight + 'px';
      
      panelHeader.addEventListener('click', () => {
        const isCollapsed = panelContent.classList.contains('collapsed');
        
        if (isCollapsed) {
          panelContent.classList.remove('collapsed');
          panelContent.style.maxHeight = panelContent.scrollHeight + 'px';
          panelIcon.classList.remove('collapsed');
        } else {
          panelContent.style.maxHeight = '0px';
          panelContent.classList.add('collapsed');
          panelIcon.classList.add('collapsed');
        }
      });

      // Point budget slider
      const budgetSlider = document.getElementById('point-budget-slider');
      const budgetDisplay = document.getElementById('point-budget-display');
      const performanceWarning = document.getElementById('performance-warning');
      const debugStatus = document.getElementById('debug-status');

      budgetSlider.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        const pointBudget = value * 1_000_000; // Convert to millions
        
        console.log(`Setting point budget to: ${pointBudget.toLocaleString()} (${value}M)`);
        debugStatus.textContent = `Setting budget to ${value}M points...`;
        
        viewer.setPointBudget(pointBudget);
        
        // Verify the setting took effect
        setTimeout(() => {
          const actualBudget = viewer.getPointBudget();
          console.log(`Point budget confirmed: ${actualBudget.toLocaleString()}`);
          debugStatus.textContent = `Active: ${(actualBudget / 1_000_000).toFixed(1)}M points`;
        }, 100);
        
        budgetDisplay.textContent = `${value.toFixed(1)}M`;
        
        // Show performance warning for high values
        if (value >= 25) {
          performanceWarning.style.display = 'block';
        } else {
          performanceWarning.style.display = 'none';
        }
        
        // Force viewer update
        if (viewer.setNeedsRedraw) {
          viewer.setNeedsRedraw();
        }
      });

      // Preset budget buttons
      document.getElementById('budget-low').addEventListener('click', () => {
        budgetSlider.value = 5;
        budgetSlider.dispatchEvent(new Event('input'));
      });

      document.getElementById('budget-medium').addEventListener('click', () => {
        budgetSlider.value = 25;
        budgetSlider.dispatchEvent(new Event('input'));
      });

      document.getElementById('budget-high').addEventListener('click', () => {
        budgetSlider.value = 50;
        budgetSlider.dispatchEvent(new Event('input'));
      });

      document.getElementById('budget-max').addEventListener('click', () => {
        budgetSlider.value = 100;
        budgetSlider.dispatchEvent(new Event('input'));
      });

      // Test budget button
      document.getElementById('test-budget').addEventListener('click', () => {
        console.log('=== BUDGET TEST ===');
        console.log('Current slider value:', budgetSlider.value);
        console.log('Viewer point budget:', viewer.getPointBudget().toLocaleString());
        console.log('Point cloud exists:', !!currentPointCloud);
        if (currentPointCloud) {
          console.log('Point cloud total points:', (currentPointCloud.numPoints || 0).toLocaleString());
          console.log('Point cloud material size:', currentPointCloud.material?.size || 'undefined');
        }
        console.log('==================');
        
        // Update debug display
        if (debugStatus) {
          debugStatus.textContent = `Test: Budget=${(viewer.getPointBudget()/1_000_000).toFixed(1)}M, Cloud=${!!currentPointCloud}`;
        }
      });

      // Point size slider
      const sizeSlider = document.getElementById('point-size-slider');
      const sizeDisplay = document.getElementById('point-size-display');

      sizeSlider.addEventListener('input', (e) => {
        const sizeValue = parseFloat(e.target.value);
        
        console.log(`Setting point size to: ${sizeValue}`);
        
        // Apply to current point cloud if it exists
        if (currentPointCloud && currentPointCloud.material) {
          currentPointCloud.material.size = sizeValue;
          console.log(`Point size applied to material: ${sizeValue}`);
        }
        
        sizeDisplay.textContent = sizeValue.toFixed(1);
        
        // Force viewer update
        if (viewer.setNeedsRedraw) {
          viewer.setNeedsRedraw();
        }
      });

      // Point size preset buttons
      document.getElementById('size-tiny').addEventListener('click', () => {
        sizeSlider.value = 0.3;
        sizeSlider.dispatchEvent(new Event('input'));
      });

      document.getElementById('size-small').addEventListener('click', () => {
        sizeSlider.value = 0.7;
        sizeSlider.dispatchEvent(new Event('input'));
      });

      document.getElementById('size-normal').addEventListener('click', () => {
        sizeSlider.value = 1.0;
        sizeSlider.dispatchEvent(new Event('input'));
      });

      document.getElementById('size-large').addEventListener('click', () => {
        sizeSlider.value = 2.0;
        sizeSlider.dispatchEvent(new Event('input'));
      });

      // Toggle controls
      document.getElementById('toggle-edl').addEventListener('click', (e) => {
        const currentEDL = viewer.getEDLEnabled();
        viewer.setEDLEnabled(!currentEDL);
        e.target.classList.toggle('active', !currentEDL);
        e.target.textContent = !currentEDL ? 'Disable EDL' : 'Enable EDL (Eye-Dome Lighting)';
        console.log('EDL toggled to:', !currentEDL);
      });

      document.getElementById('toggle-sidebar').addEventListener('click', () => {
        viewer.toggleSidebar();
      });

      document.getElementById('fit-screen').addEventListener('click', () => {
        viewer.fitToScreen();
      });

      // Animation controls
      document.getElementById('toggle-rotation').addEventListener('click', toggleRotation);
      document.getElementById('reset-view').addEventListener('click', resetView);
      document.getElementById('create-animation').addEventListener('click', () => {
        try {
          const toolsMenu = document.querySelector('#menu_tools');
          if (toolsMenu) {
            toolsMenu.click();
          }
          alert('Navigate to "Tools ‚Üí Navigation ‚Üí Camera Animation" to create camera paths for detailed substrate analysis');
        } catch (err) {
          alert('To create camera animations:\n1. Open the sidebar\n2. Go to Tools ‚Üí Navigation ‚Üí Camera Animation\n3. Add keyframes at different viewpoints\n4. Use for detailed substrate inspection');
        }
      });

      console.log('Substrate controls initialized');
    }

    // Load the substrate stabilization point cloud
    function loadSubstratePointCloud() {
      console.log('Loading substrate point cloud...');
      console.log('URL:', PROJECT_CONFIG.pointCloud.url);
      
      try {
        Potree.loadPointCloud(PROJECT_CONFIG.pointCloud.url, PROJECT_CONFIG.pointCloud.name, (e) => {
          console.log('Substrate point cloud callback:', e);
          
          if (e.type === 'loading_failed' || !e.pointcloud) {
            console.error('Failed to load substrate point cloud:', e);
            loading.style.display = 'none';
            showError('Failed to load substrate stabilization point cloud. Please check the data source.');
            return;
          }
          
          const pointcloud = e.pointcloud;
          console.log(`Substrate point cloud loaded - Points: ${pointcloud.numPoints?.toLocaleString() || 'Unknown'}`);
          
          // Configure point cloud
          pointcloud.name = PROJECT_CONFIG.pointCloud.name;
          
          let material = pointcloud.material;
          material.size = 1;
          material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
          material.shape = Potree.PointShape.SQUARE;
          
          // Apply marine-appropriate color tint
          if (PROJECT_CONFIG.pointCloud.color) {
            material.color = PROJECT_CONFIG.pointCloud.color;
          }
          
          // Store reference
          currentPointCloud = pointcloud;
          
          // Add to scene
          viewer.scene.addPointCloud(pointcloud);
          
          // Set up initial view
          viewer.fitToScreen();
          viewer.setMoveSpeed(pointcloud.boundingSphere.radius / 5);
          
          // Hide loading
          loading.style.display = 'none';
          
          // Update debug status
          const debugStatus = document.getElementById('debug-status');
          if (debugStatus) {
            debugStatus.textContent = `Loaded: ${(pointcloud.numPoints || 0).toLocaleString()} points available`;
          }
          
          // Enable EDL after loading for better quality
          setTimeout(() => {
            viewer.setEDLEnabled(true);
            const edlBtn = document.getElementById('toggle-edl');
            edlBtn.classList.add('active');
            edlBtn.textContent = 'Disable EDL';
            console.log('EDL enabled for substrate analysis');
            
            // Update status with initial budget
            if (debugStatus) {
              const currentBudget = viewer.getPointBudget();
              debugStatus.textContent = `Active: ${(currentBudget / 1_000_000).toFixed(1)}M points of ${(pointcloud.numPoints || 0).toLocaleString()} available`;
            }
          }, 1000);
          
          console.log('Substrate point cloud setup complete');
        });
        
      } catch (error) {
        console.error('Error loading substrate point cloud:', error);
        loading.style.display = 'none';
        showError('Failed to initialize substrate point cloud loading');
      }
    }

    // Initialize location map
    function initializeLocationMap() {
      try {
        const { lat, lng, name, description } = PROJECT_CONFIG.location;
        
        // Create map centered on the location
        const map = L.map('map', {
          zoomControl: false,
          attributionControl: true,
          scrollWheelZoom: false,
          doubleClickZoom: false,
          dragging: true
        }).setView([lat, lng], 10);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 18
        }).addTo(map);
        
        // Add marker for the substrate site
        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`
          <div style="text-align: center;">
            <strong>${PROJECT_CONFIG.name}</strong><br>
            ${name}<br>
            <small>${description}</small><br>
            <small>üìç ${Math.abs(lat).toFixed(5)}¬∞${lat < 0 ? 'S' : 'N'}, ${Math.abs(lng).toFixed(5)}¬∞${lng < 0 ? 'W' : 'E'}</small>
          </div>
        `);
        
        // Add controls
        L.control.scale({ position: 'bottomleft' }).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);
        
        // Add study area circle
        L.circle([lat, lng], {
          color: '#00bcd4',
          fillColor: '#00bcd4',
          fillOpacity: 0.2,
          radius: 1000 // 1km radius for substrate area
        }).addTo(map);
        
        console.log('Substrate location map initialized');
        
      } catch (error) {
        console.error('Error initializing map:', error);
      }
    }

    // Rotation animation
    function toggleRotation() {
      const btn = document.getElementById('toggle-rotation');
      
      if (isAnimating) {
        stopRotation();
        btn.textContent = 'üîÑ Rotate View';
        btn.classList.remove('playing');
      } else {
        startRotation();
        btn.textContent = '‚è∏ Stop Rotation';
        btn.classList.add('playing');
      }
    }

    function startRotation() {
      if (isAnimating || !viewer.scene) return;
      
      isAnimating = true;
      const view = viewer.scene.view;
      const initialYaw = view.yaw || 0;
      let startTime = Date.now();
      
      function animate() {
        if (!isAnimating) return;
        
        const elapsed = Date.now() - startTime;
        const progress = (elapsed % 20000) / 20000; // 20 second rotation
        
        view.yaw = initialYaw + (progress * Math.PI * 2);
        
        if (view.update) {
          view.update();
        }
        
        animationId = requestAnimationFrame(animate);
      }
      
      animate();
      console.log('Substrate rotation started');
    }

    function stopRotation() {
      isAnimating = false;
      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
      console.log('Substrate rotation stopped');
    }

    function resetView() {
      stopRotation();
      const btn = document.getElementById('toggle-rotation');
      btn.textContent = 'üîÑ Rotate View';
      btn.classList.remove('playing');
      
      if (currentPointCloud) {
        viewer.fitToScreen();
      }
    }

    // Export functions (same as other viewers but customized for substrate)
    window.initializeSidebarExports = function() {
      const checkSidebar = () => {
        const btnScreenshot = document.getElementById('btnExportScreenshot');
        const btnCamera = document.getElementById('btnExportCamera');
        const btnMeasurements = document.getElementById('btnExportMeasurements');
        const btnShareLink = document.getElementById('btnShareLink');
        const btnLoadCamera = document.getElementById('btnLoadCamera');
        const cameraFileInput = document.getElementById('cameraFileInput');

        if (btnScreenshot && btnCamera && btnMeasurements && btnShareLink && btnLoadCamera && cameraFileInput) {
          // Screenshot export
          btnScreenshot.onclick = () => {
            try {
              const dataURL = viewer.renderer.domElement.toDataURL('image/png');
              const a = document.createElement('a');
              a.href = dataURL;
              a.download = 'substrate-stabilization-screenshot.png';
              document.body.appendChild(a);
              a.click();
              a.remove();
            } catch (err) {
              alert('Screenshot failed. Some browsers require special flags for WebGL capture.');
              console.error(err);
            }
          };

          // Camera export
          btnCamera.onclick = () => {
            const cameraData = window.getCameraState();
            const blob = new Blob([JSON.stringify(cameraData, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'substrate-stabilization-camera.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
          };

          // Measurements export
          btnMeasurements.onclick = () => {
            try {
              const out = [];
              const ms = (viewer.measuringTool.measurements || viewer.measuringTool.measures || []);
              for (const m of ms) {
                const pts = (m.points || []).map(p => p.position.toArray());
                out.push({ name: m.name || 'Substrate Measure', closed: !!m.closed, points: pts });
              }
              const blob = new Blob([JSON.stringify({ measurements: out }, null, 2)], {type: 'application/json'});
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = 'substrate-stabilization-measurements.json';
              document.body.appendChild(a);
              a.click();
              a.remove();
            } catch (err) {
              alert('No measurements found or export failed.');
              console.error(err);
            }
          };

          // Share link
          btnShareLink.onclick = async () => {
            const u = new URL('substrate-viewer.html', location.href);
            try {
              await navigator.clipboard.writeText(u.toString());
              alert('Substrate viewer link copied to clipboard');
            } catch {
              prompt('Copy substrate viewer link:', u.toString());
            }
          };

          // Load camera
          btnLoadCamera.onclick = () => {
            cameraFileInput.click();
          };

          cameraFileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  const cameraData = JSON.parse(e.target.result);
                  window.setCameraState(cameraData);
                  alert('Camera position loaded successfully');
                } catch (err) {
                  alert('Invalid camera file: ' + err.message);
                }
              };
              reader.readAsText(file);
            }
          };

        } else {
          setTimeout(checkSidebar, 100);
        }
      };

      checkSidebar();
    };

    window.getCameraState = function() {
      try {
        const v = viewer.scene.view;
        const cam = viewer.scene.getActiveCamera();
        
        let target = [0, 0, 0];
        if (v.getPivot) {
          const pivot = v.getPivot();
          target = pivot.toArray ? pivot.toArray() : [pivot.x, pivot.y, pivot.z];
        } else if (v.pivot) {
          target = v.pivot.toArray ? v.pivot.toArray() : [v.pivot.x, v.pivot.y, v.pivot.z];
        }
        
        const cameraState = {
          position: cam.position.toArray(),
          target: target,
          fov: cam.fov || v.fov || 60,
          project: PROJECT_CONFIG.name
        };
        
        if (v.yaw !== undefined) cameraState.yaw = v.yaw;
        if (v.pitch !== undefined) cameraState.pitch = v.pitch;
        if (v.radius !== undefined) cameraState.radius = v.radius;
        
        return cameraState;
      } catch (error) {
        console.error('Error getting camera state:', error);
        const cam = viewer.scene.getActiveCamera();
        return {
          position: cam.position.toArray(),
          target: [0, 0, 0],
          fov: cam.fov || 60,
          project: PROJECT_CONFIG.name
        };
      }
    };

    window.setCameraState = function(state) {
      try {
        console.log('Setting camera state:', state);
        const v = viewer.scene.view;
        const cam = viewer.scene.getActiveCamera();
        
        if (state.position && Array.isArray(state.position) && state.position.length === 3) {
          cam.position.set(state.position[0], state.position[1], state.position[2]);
          console.log('Camera position set to:', state.position);
        }
        
        if (typeof state.fov === 'number') {
          cam.fov = state.fov;
          cam.updateProjectionMatrix();
          console.log('Camera FOV set to:', state.fov);
        }
        
        if (typeof state.yaw === 'number' && v.yaw !== undefined) {
          v.yaw = state.yaw;
          console.log('View yaw set to:', state.yaw);
        }
        if (typeof state.pitch === 'number' && v.pitch !== undefined) {
          v.pitch = state.pitch;
          console.log('View pitch set to:', state.pitch);
        }
        if (typeof state.radius === 'number' && v.radius !== undefined) {
          v.radius = state.radius;
          console.log('View radius set to:', state.radius);
        }
        
        if (state.target && Array.isArray(state.target) && state.target.length === 3) {
          const targetVector = new THREE.Vector3(state.target[0], state.target[1], state.target[2]);
          
          if (v.lookAt) {
            v.lookAt(targetVector);
            console.log('Used view.lookAt for target:', state.target);
          } else if (v.setPivot) {
            v.setPivot(targetVector);
            console.log('Used view.setPivot for target:', state.target);
          } else {
            cam.lookAt(targetVector);
            console.log('Used camera.lookAt for target:', state.target);
          }
        }
        
        if (v.update) {
          v.update();
        }
        
        if (viewer.setNeedsRedraw) {
          viewer.setNeedsRedraw();
        }
        
        if (viewer.render) {
          viewer.render();
        }
        
        console.log('Camera state applied successfully');
        
      } catch (error) {
        console.error('Error in setCameraState:', error);
        
        try {
          console.log('Attempting fallback camera positioning...');
          const cam = viewer.scene.getActiveCamera();
          
          if (state.position && Array.isArray(state.position) && state.position.length === 3) {
            cam.position.set(state.position[0], state.position[1], state.position[2]);
          }
          
          if (state.target && Array.isArray(state.target) && state.target.length === 3) {
            cam.lookAt(new THREE.Vector3(state.target[0], state.target[1], state.target[2]));
          }
          
          if (typeof state.fov === 'number') {
            cam.fov = state.fov;
            cam.updateProjectionMatrix();
          }
          
          if (viewer.setNeedsRedraw) {
            viewer.setNeedsRedraw();
          } else if (viewer.render) {
            viewer.render();
          }
          
          console.log('Fallback camera positioning successful');
          
        } catch (fallbackError) {
          console.error('Fallback camera setting failed:', fallbackError);
          throw new Error('Could not set camera position - both main and fallback methods failed');
        }
      }
    };
  </script>
</body>
</html>
